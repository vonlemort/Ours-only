<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Me & The love of my life's Website</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{--bg1:#fff6fb;--accent:#ff6fa6;--muted:#7a3a4f;--paper:#fffecb}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Quicksand',system-ui,Arial;background:linear-gradient(180deg,var(--bg1),#fff);overflow-x:hidden}

    /* ---- Gate ---- */
    .gateWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff0fb,#fff);z-index:80}
    .gateCard{width:100%;max-width:520px;padding:32px;border-radius:18px;background:linear-gradient(180deg,#fff,#fff8fb);box-shadow:0 20px 50px rgba(255,111,160,0.15);text-align:center;animation:pop .6s ease}
    .lockBig{font-size:80px;animation:pulse 2s infinite}
    .codeInput{width:100%;padding:14px;border-radius:12px;border:2px solid rgba(255,111,160,0.14);font-size:18px;margin-top:16px}
    .btn{padding:12px 18px;border-radius:12px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer;margin-top:12px;transition:transform .2s}
    .btn:hover{transform:scale(1.05)}
    .btn.small{padding:8px 12px;border-radius:10px}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    @keyframes pop{0%{transform:scale(.9);opacity:0}100%{transform:scale(1);opacity:1}}

    /* ---- App / Hub ---- */
    .app{display:none;position:relative;z-index:2;min-height:100vh;width:100%;flex-direction:column;align-items:center}
    .hub{min-height:70vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;text-align:center;padding-top:60px}
    .title{font-size:46px;color:var(--accent);margin:0;text-shadow:0 2px 0 #fff,0 10px 30px rgba(255,111,160,.25)}

    /* peeking Hello Kitty in title */
    .titlePeekWrap{
      position:relative;
      display:inline-block;
      padding-left:34px; /* space so the W doesn‚Äôt get pushed by the gif */
    }
    .kittyPeekHead{
      position:absolute;
      left:-5px;          /* tweak these to line it up perfectly */
      bottom:-6px;
      height:55px;        /* size of the gif */
      pointer-events:none;/* so clicks go through it */
    }

    .subtitle{color:var(--muted);max-width:720px;margin:0}
    .bigBtns{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .bigBtn{width:260px;height:180px;border-radius:18px;background:linear-gradient(180deg,#fff,#fff0fb);display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 12px 36px rgba(0,0,0,0.06);cursor:pointer;transition:transform .2s;position:relative;padding:12px}
    .bigBtn .label{font-weight:800;margin-top:6px}
    .bigBtn .desc{font-size:13px;color:var(--muted);max-width:220px;opacity:.9;margin-top:6px}
    .bigBtn:hover{transform:scale(1.05)}
    
    main{width:100%;padding:22px 16px;display:flex;flex-direction:column;align-items:center}
    .page{display:none;min-height:60vh;width:100%;max-width:1100px}
    .page.active{display:block}
    .backRow{display:flex;justify-content:center}
    .backBtn{margin:8px 0 18px;padding:10px 16px;border:none;border-radius:12px;background:var(--accent);color:white;cursor:pointer;transition:transform .2s}
    .backBtn:hover{transform:scale(1.05)}

    /* ---- Animated background ---- */
    .floatingBg span{position:fixed;pointer-events:none;z-index:0;animation:float 6s ease-in-out infinite;opacity:0.4}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-18px)}100%{transform:translateY(0)}}

    /* ---- Notes ---- */
    .noteInputRow{display:flex;justify-content:center;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .noteInputRow input{padding:10px;border-radius:10px;border:1px solid #d9c6cf;min-width:320px}
    .notesBoard{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;background:linear-gradient(180deg,#fff0fb,#fff);padding:20px;border-radius:14px}
    .noteCard{position:relative;display:flex;flex-direction:column;background:var(--paper);padding:26px 18px 12px;border-radius:10px;min-height:160px;max-width:360px;box-shadow:0 8px 22px rgba(0,0,0,0.15);transform:rotate(calc(-3deg + 6deg * var(--r)));overflow:visible}
    .noteCard p{margin:0;font-size:15px;color:#6c3446;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;line-height:1.45}
    .noteCard small{display:block;color:#8b6b73;font-size:12px}
    .pin{position:absolute;top:-14px;left:50%;transform:translateX(-50%);width:18px;height:18px;background:#e84343;border-radius:50%;box-shadow:0 3px 0 0 #b82e2e, 0 10px 14px rgba(0,0,0,0.25);z-index:1}
    .pin:after{content:"";position:absolute;inset:5px;width:8px;height:8px;background:#ff9a9a;border-radius:50%}
    .noteBody{flex:1;max-height:220px;overflow:auto}
    .noteFooter{margin-top:10px;padding-top:8px;border-top:1px dashed #e0cbd3;display:flex;justify-content:space-between;align-items:center}

    /* ---- Songs ---- */
    .songsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px}
    @keyframes slowFloat{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
    .songCard{position:relative;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08);padding:12px;text-align:center;animation:slowFloat 8s ease-in-out infinite;animation-delay:var(--d,0s)}
    .songCard:nth-child(2n){--d:1s}.songCard:nth-child(3n){--d:2s}.songCard:nth-child(4n){--d:3s}
    .cover{position:relative;width:150px;height:150px;border-radius:14px;overflow:hidden;margin:6px auto;border:2px solid rgba(255,255,255,0.8);box-shadow:0 8px 26px rgba(255,111,166,0.2), inset 0 0 0 1px rgba(255,255,255,0.5);background:#fff}
    .cover img{width:100%;height:100%;object-fit:cover}
    .cover:before{content:"";position:absolute;left:-10%;top:-20%;width:140%;height:50%;background:linear-gradient(to bottom, rgba(255,255,255,.65), rgba(255,255,255,0));transform:rotate(12deg);pointer-events:none}
    .cover:after{content:"";position:absolute;inset:0;pointer-events:none;box-shadow:inset 0 0 30px rgba(255,255,255,.15)}
    .songTitle{font-weight:700;color:var(--muted)}
    .playBtn{margin-top:8px;padding:8px 12px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}

    /* ---- Custom audio player ---- */
    .audioWrap{display:flex;justify-content:center}
    .audioPlayer{width:100%;max-width:720px;margin:16px auto 0;background:linear-gradient(180deg,#fff,#fff7fb);border:2px solid rgba(255,111,166,0.15);border-radius:22px;padding:12px 16px;box-shadow:0 12px 28px rgba(255,111,166,0.18);display:grid;grid-template-columns:auto 1fr auto;gap:14px;align-items:center}
    .ap-cover{width:56px;height:56px;border-radius:50%;overflow:hidden;box-shadow:0 6px 16px rgba(255,111,166,.35);display:flex;align-items:center;justify-content:center;background:#fff}
    .ap-cover img{width:100%;height:100%;object-fit:cover}
    .ap-main{display:flex;flex-direction:column;gap:8px}
    .ap-title{font-weight:800;color:var(--muted);line-height:1}
    .ap-time{font-size:12px;color:#8b6b73}
    .ap-bar{height:10px;border-radius:999px;background:rgba(255,111,166,.18);position:relative;cursor:pointer;overflow:hidden}
    .ap-fill{position:absolute;left:0;top:0;height:100%;width:0%;background:var(--accent);border-radius:999px;box-shadow:0 2px 8px rgba(255,111,166,0.4)}
    .ap-ctrls{display:flex;gap:8px}
    .ap-btn{border:none;background:var(--accent);color:#fff;font-weight:800;width:44px;height:44px;border-radius:50%;cursor:pointer;box-shadow:0 6px 16px rgba(255,111,166,0.35);display:flex;align-items:center;justify-content:center;font-size:16px}
    .ap-btn:active{transform:scale(.98)}

    /* ---- Photos ---- */
    .photosWall{background:linear-gradient(180deg,#fff0fb,#fff);border-radius:14px;padding:18px}
    .polaroidGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:22px;align-items:start}
    .polaroid{position:relative;width:100%;padding:12px 12px 38px;background:#fff;border-radius:10px;border:10px solid #fff;box-shadow:0 14px 26px rgba(0,0,0,0.16), 0 2px 6px rgba(0,0,0,0.08);transform:rotate(calc(-3deg + 6deg*var(--rot, .5)));transition:transform .22s;margin-top:var(--mt,0);cursor:zoom-in;overflow:visible}
    .polaroid:hover{transform:rotate(0deg) scale(1.02)}
    .polaroid img, .polaroid video{width:100%;height:190px;object-fit:cover;border-radius:6px;display:block}
    .polaroid .caption{position:absolute;left:0;right:0;bottom:6px;text-align:center;font-size:12px;color:#8b6b73;pointer-events:none}
    .polaroid:nth-child(2n){--mt:6px}.polaroid:nth-child(3n){--mt:18px}.polaroid:nth-child(4n){--mt:10px}.polaroid:nth-child(5n){--mt:24px}
    .photoCats{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin:10px 0 18px}
    .photoBtn{width:240px;height:120px;border-radius:16px;background:linear-gradient(180deg,#fff,#fff0fb);display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 12px 36px rgba(0,0,0,0.06);cursor:pointer;transition:transform .2s;padding:10px}
    .photoBtn .label{font-weight:800}
    .photoBtn .desc{font-size:12px;color:var(--muted);max-width:210px;margin-top:4px}
    .photoBtn:hover{transform:scale(1.05)}

    /* ---- Cute footer ---- */
    .cuteFooter{position:fixed;left:0;right:0;bottom:8px;display:none;align-items:center;justify-content:center;gap:14px;pointer-events:none;z-index:3}
    .kitty{width:64px;height:64px;animation:kittyWalk 10s linear infinite}
    @keyframes kittyWalk{0%{transform:translateX(-40vw)}50%{transform:translateX(0)}100%{transform:translateX(40vw)}}

    /* === Calendar (hidden until unlock) === */
    #calendarBtn.hiddenBeforeUnlock,
    #calShell.hiddenBeforeUnlock { display:none !important; }

    .cal-shell{
      --pink:#ff6fa6; --ink:#b03050; --paper:#fff9fc; --pen:#e83434;
      position:fixed;top:70px;right:20px;width:640px;max-height:85vh;background:var(--paper);
      border:2px solid rgba(255,111,166,.25);border-radius:18px;box-shadow:0 10px 30px rgba(255,111,166,.25);
      padding:14px;overflow-y:auto;overflow-x:hidden;transform-origin:top right;opacity:0;pointer-events:none;
      transform:translateY(-20px) scale(.97);transition:all .45s cubic-bezier(.23,1,.32,1);z-index:90
    }
    .cal-shell.show{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}

    /* fully remove from layout when hidden, so it never intercepts clicks */
    #calShell:not(.show){display:none !important;pointer-events:none !important;}
    #calendarBtn {
      position: fixed; top: 18px; right: 18px;
      background: #fff; color: #ff6fa6; border: 2px solid rgba(255,111,166,0.4);
      font-weight: 800; border-radius: 50px; padding: 10px 18px;
      box-shadow: 0 6px 16px rgba(255,111,166,.25); cursor: pointer; z-index: 100; transition: all 0.25s ease;
    }
    #calendarBtn:hover { background: #ff6fa6; color: #fff; transform: scale(1.05); }

    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-title{font-weight:800;color:var(--pink);font-size:16px}
    .nav-btn{border:none;background:var(--pink);color:#fff;width:32px;height:32px;border-radius:10px;cursor:pointer;box-shadow:0 5px 14px rgba(255,111,166,.35);font-weight:800}

    .sticky-notes{display:flex;flex-wrap:wrap;gap:6px;margin:4px 0 10px}
    .sticky{background:#fff7f9;border:1px dashed rgba(232,52,52,.35);color:#e83434;padding:4px 6px;border-radius:8px;box-shadow:0 3px 10px rgba(255,111,166,.12);font-size:11px}

    .tagForm{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:6px 0 10px}
    .tagForm input[type="date"], .tagForm input[type="text"]{
      padding:10px;border-radius:10px;border:1px solid #e8c9d6;min-width:160px;flex:1
    }

    .year-container{position:relative}
    .year-page{
      /* NO absolute/inset here */
      display:none;               /* hidden by default */
      transition: opacity .25s ease;
      opacity:0;
    }
    .year-page.visible{
      display:block;
      opacity:1;
    }
    .year-page.hidden{
      display:none;
      opacity:0;
    }

    .month-wrap{display:grid;grid-template-columns:repeat(3,minmax(180px,1fr));gap:10px;margin-bottom:10px}
    .month{background:#fff;border:1px solid rgba(255,111,166,.18);border-radius:12px;padding:8px;box-shadow:0 6px 14px rgba(255,111,166,.12)}
    .m-title{text-align:center;font-weight:800;font-size:12px;color:#b03050;margin-bottom:6px}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
    .dow{font-size:10px;text-align:center;color:#7a3a4f}
    .day{position:relative;aspect-ratio:1/1;border-radius:8px;background:linear-gradient(180deg,#fff,#fff7fb);display:flex;align-items:center;justify-content:center;font-weight:700;color:#7a3a4f;font-size:12px;border:1px solid rgba(255,111,166,.10);cursor:pointer}
    .day.other{opacity:.35;cursor:default}
    .pen-circle::after{content:"";position:absolute;inset:3px;border-radius:10px;border:1.6px solid #e83434;transform:rotate(-2deg)}
    .pen-underline::after{content:"";position:absolute;left:6px;right:6px;bottom:4px;height:1.6px;background:#e83434;transform:rotate(-2deg)}
    .pen-x::after{content:"‚úó";position:absolute;color:#e83434;font-size:10px;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-8deg)}
    .info{margin-top:12px;padding:10px;background:#fff;border:1px dashed rgba(255,111,166,.35);border-radius:12px;text-align:center;color:#7a3a4f}
    .big{font-weight:800;color:#ff6fa6}
    .tiny{font-size:12px;opacity:.9}

    /* === Calendar tags (chips + circle mark + tooltip) === */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 12px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px dashed rgba(232,52,52,.35);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;box-shadow:0 3px 10px rgba(255,111,166,.12)}
    .chip .x{border:none;background:transparent;color:#c03636;font-weight:900;cursor:pointer}
    .day.tagged::after{content:"";position:absolute;inset:4px;border-radius:12px;border:2px solid #e83434;transform:rotate(-2deg);filter:drop-shadow(0 1px 0 rgba(232,52,52,.35))}
    .day[data-label]:hover::before{
      content:attr(data-label); position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      background:#fff;border:1px dashed rgba(232,52,52,.4);color:#e83434;padding:4px 6px;border-radius:8px;font-size:11px;white-space:nowrap;box-shadow:0 6px 16px rgba(255,111,166,.12)
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <!-- animated sparkle layer -->
  <div class="floatingBg" id="floatingBg"></div>

  <!-- Calendar UI (hidden until unlock) -->
  <button id="calendarBtn" class="hiddenBeforeUnlock">üìÖ Calendar</button>

  <div class="cal-shell hiddenBeforeUnlock" id="calShell" aria-modal="true" role="dialog">
    <div class="cal-header">
      <button class="nav-btn" id="prevBtn" aria-label="Previous year">‚Äπ</button>
      <div class="cal-title" id="calTitle">Our Little Calendar ‚Äî 2025</div>
      <button class="nav-btn" id="nextBtn" aria-label="Next year">‚Ä∫</button>
    </div>

    <!-- Tag input row -->
    <div class="tagForm">
      <input type="date" id="tagDate">
      <input type="text" id="tagLabel" placeholder="Write a tag...">
      <button id="addTagBtn" class="btn small">Add Tag</button>
    </div>

    <div class="sticky-notes">
      <div class="chips" id="calChips"></div>
      <div class="sticky">Jul 15 ‚Äî First text since the big thing</div>
      <div class="sticky">Jul 20 ‚Äî The first time we met üíû</div>
      <div class="sticky">Aug 19‚Äì22 ‚Äî Our 2nd time hanging out (last day was in Aug 22)</div>
      <div class="sticky">Dec 12 ‚Äî My Wife‚Äôs birthdayyy</div>
    </div>

    <div class="year-container" id="yearContainer">
      <div class="year-page visible" id="year2025"></div>
      <div class="year-page hidden"  id="year2026"></div>
    </div>

    <div class="info">
      <div class="big" id="sinceText">Day ‚Ä¶ since the last time we saw eachother irl</div>
      <div class="tiny" id="countdown">Next day in ‚Ä¶</div>
      <div class="tiny">The next time that we might meet in hopefully <span class="big">Jul‚ÄìAug 2026</span></div>
      <div class="tiny">Time zone: Your device time</div>
    </div>
  </div>

  <!-- Gate -->
  <div class="gateWrap" id="gateWrap">
    <div class="gateCard">
      <div class="lockBig">üîí</div>
      <h2>Enter our secret code</h2>
      <p style="color:var(--muted)">Only Khadeja and Saleh know the secret codeee</p>
      <input id="codeField" class="codeInput" placeholder="Type the secret code..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      <button id="submitCode" class="btn">Unlock Love üíû</button>
      <p id="gateMsg" style="color:crimson;margin-top:10px"></p>
    </div>
  </div>

  <!-- App shell -->
  <div class="app" id="appShell"></div>

  <!-- HUB footer decorations (hub only) -->
  <div class="cuteFooter" id="cuteFooter">
    <img class="kitty" src="assets/hello-kitty.gif" alt="Hello Kitty" onerror="this.style.display='none'"/>
  </div>

  <!-- Lightbox for photos/videos -->
  <div id="lightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);z-index:120;align-items:center;justify-content:center;padding:16px">
    <div id="lightboxInner" style="max-width:90vw;max-height:90vh;background:#fff;border:12px solid #fff;border-radius:12px;box-shadow:0 30px 60px rgba(0,0,0,.25);position:relative;padding:10px 10px 36px">
      <button id="lbClose" style="position:absolute;right:8px;top:8px;border:none;background:var(--accent);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer">Close</button>
      <div id="lbContent" style="width:72vw;max-width:820px;max-height:72vh;display:flex;align-items:center;justify-content:center"></div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }
    function coverFallback(img){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'><rect width='100%' height='100%' fill='%23ffe1ee'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='18' fill='%23ff6fa6'>No cover</text></svg>`);
      img.src = `data:image/svg+xml,${svg}`;
    }
    function todayISO(){
      const t = new Date();
      const m = String(t.getMonth()+1).padStart(2,'0');
      const d = String(t.getDate()).padStart(2,'0');
      return `${t.getFullYear()}-${m}-${d}`;
    }

    // ===== Lock screen =====
    const SECRET = 'Khadeja_Has_My_Heart';
    const gateWrap = document.getElementById('gateWrap');
    const appShell = document.getElementById('appShell');
    const cuteFooter = document.getElementById('cuteFooter');
    function showGate(){ gateWrap.style.display='flex'; appShell.style.display='none'; cuteFooter.style.display='none'; }
    function showApp(){ gateWrap.style.display='none'; appShell.style.display='flex'; }

    // ===== Animated background =====
    const bg = document.getElementById('floatingBg');
    const symbols = ['üíñ','üíû','üíò','‚ú®','üåü','üí´'];
    for(let i=0;i<80;i++){
      const s=document.createElement('span');
      s.textContent=symbols[Math.floor(Math.random()*symbols.length)];
      s.style.left=Math.random()*100+'%';
      s.style.top=Math.random()*100+'%';
      s.style.fontSize=12+Math.random()*24+'px';
      s.style.animationDuration=5+Math.random()*6+'s';
      bg.appendChild(s);
    }

    // ===== Firebase init =====
    const firebaseConfig = {
      apiKey: "AIzaSyD7Rt9RFyk6DHsaqB_2KIv0QBGPGXYrWPo",
      authDomain: "notes-8d314.firebaseapp.com",
      databaseURL: "https://notes-8d314-default-rtdb.firebaseio.com",
      projectId: "notes-8d314",
      storageBucket: "notes-8d314.firebasestorage.app",
      messagingSenderId: "46616929171",
      appId: "1:46616929171:web:c3981641b271d3e33b3e66"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously().catch(console.error);
    let CURRENT_UID = null;
    firebase.auth().onAuthStateChanged(user => { if (user) CURRENT_UID = user.uid; });
    const db = firebase.database();
    const ROOM_ID = 'for-khadeja';

    // Calendar tags path
    const TAGS_REF = db.ref(`rooms/${ROOM_ID}/calendarTags`);

    // ===== Build Hub + Pages =====
    function initHub(){
      appShell.innerHTML = `
        <section class="hub">
          <h1 class="title">
            <span class="titlePeekWrap">
              <img src="assets/hello-kitty-peek.gif" alt="" class="kittyPeekHead">
              <span>Welcome my love üíû</span>
            </span>
          </h1>
          <p class="subtitle">Check these sections Mon Amour ‚ú®</p>
          <div class="bigBtns">
            <div class="bigBtn" onclick="openPage('notes')">üíå
              <div class="label">Notes</div>
              <div class="desc">Write anything you want to tell me here Khadeja, the love of my life</div>
            </div>
            <div class="bigBtn" onclick="openPage('songs')">üéµ
              <div class="label">Songs</div>
              <div class="desc">Songs that remind me of usss</div>
            </div>
            <div class="bigBtn" onclick="openPage('photos')">üì∏
              <div class="label">Photos</div>
              <div class="desc">Our memories togetherr</div>
            </div>
          </div>
        </section>
        <main>
          <!-- NOTES PAGE -->
          <section id="notes" class="page">
            <div class="backRow"><button class="backBtn" onclick="openPage('hub')">‚Üê Back</button></div>
            <div class="noteInputRow">
              <input id="noteContent" placeholder="Write a note" autocomplete="off" autocorrect="off" spellcheck="false" />
              <button class="btn" id="addNoteBtn">Pin Note</button>
            </div>
            <div class="notesBoard" id="notesBoard"></div>
          </section>

          <!-- SONGS PAGE -->
          <section id="songs" class="page">
            <div class="backRow"><button class="backBtn" onclick="openPage('hub')">‚Üê Back</button></div>
            <div class="songsGrid" id="songsGrid"></div>
            <div class="audioWrap">
              <div id="ap" class="audioPlayer">
                <div class="ap-cover"><img id="apCover" alt="cover" src="" onerror="this.src='songs/covers/3005.jpg'"></div>
                <div class="ap-main">
                  <div class="ap-title" id="apTitle">Pick a song</div>
                  <div class="ap-bar" id="apBar"><div class="ap-fill" id="apFill"></div></div>
                  <div class="ap-time"><span id="apNow">0:00</span> ‚Ä¢ <span id="apDur">0:00</span></div>
                </div>
                <div class="ap-ctrls">
                  <button id="apPrev" class="ap-btn">‚èÆ</button>
                  <button id="apPlay" class="ap-btn">‚ñ∫</button>
                  <button id="apNext" class="ap-btn">‚è≠</button>
                </div>
              </div>
            </div>
            <audio id="player" style="display:none"></audio>
          </section>

          <!-- PHOTOS PAGE -->
          <section id="photos" class="page">
            <div class="backRow"><button class="backBtn" onclick="openPage('hub')">‚Üê Back</button></div>
            <div class="photoCats" id="photoCats">
              <div class="photoBtn" onclick="openPhotoCat('calls')">üì±
                <div class="label">Calls</div>
                <div class="desc">Us being togetherrr on call</div>
              </div>
              <div class="photoBtn" onclick="openPhotoCat('irl')">ü§ç
                <div class="label">Real Life</div>
                <div class="desc">Photos from when we were together in real life.</div>
              </div>
            </div>
            <div class="photosWall" id="photosWall" style="display:none">
              <div style="text-align:center;margin-bottom:10px"><button class="backBtn" onclick="closePhotoCat()">‚Üê Back to photo categories</button></div>
              <div class="polaroidGrid" id="polaroidGrid"></div>
            </div>
          </section>
        </main>`;

      // Show hub + footer
      openPage('hub');
      cuteFooter.style.display = 'flex';

      // ===== NOTES logic =====
      const notesBoard = document.getElementById('notesBoard');
      const addBtn = document.getElementById('addNoteBtn');
      const input  = document.getElementById('noteContent');

      addBtn.addEventListener('click', ()=>{
        const v = input.value.trim();
        if(!v) return;
        db.ref(`rooms/${ROOM_ID}/notes`).push({
          type:'text', text:v, time:Date.now(), uid: CURRENT_UID || null
        });
        input.value='';
      });

      db.ref(`rooms/${ROOM_ID}/notes`).on('value', (snapshot) => {
        notesBoard.innerHTML = '';
        const data = snapshot.val();
        if (!data) return;
        const entries = Object.entries(data).sort((a,b)=>(b[1].time||0)-(a[1].time||0));
        for (const [key, n] of entries) {
          const card = document.createElement('div');
          card.className = 'noteCard';
          card.style.setProperty('--r', (Math.random()*0.8 - 0.4).toFixed(2));
          const dateStr = new Date(n.time||Date.now()).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
          card.innerHTML = `
            <span class="pin" aria-hidden="true"></span>
            <div class="noteBody"><p>${escapeHtml(n.text||'')}</p></div>
            <div class="noteFooter"><small>Added on ${dateStr}</small></div>`;
          notesBoard.appendChild(card);
        }
      });

      // ===== SONGS behavior =====
      const songs = [
        { file: 'songs/K.mp3',                cover:'songs/covers/K..jpg',            title:'K.',                 artist:'Cigarettes After Sex' },
        { file: 'songs/RightOne.mp3',         cover:'songs/covers/rightone.jpg',      title:'The Right One',      artist:'Sports' },
        { file: 'songs/3005.mp3',             cover:'songs/covers/3005.jpg',          title:'3005',               artist:'Childish Gambino' },
        { file: 'songs/KISS.mp3',             cover:'songs/covers/KISS.JPG',          title:'Kiss Of Life',       artist:'Sade' },
        { file: 'songs/For the First Time.mp3', cover:'songs/covers/ForTheFirstTime.jpg', title:'For The First Time', artist:'Mac DeMarco' }
      ];
      const songsGrid = document.getElementById('songsGrid');
      const player    = document.getElementById('player');

      songs.forEach((s, idx)=>{
        const card = document.createElement('div');
        card.className = 'songCard';
        card.innerHTML = `
          <div class="cover"><img src="${s.cover}" alt="${s.title} cover" onerror="coverFallback(this)"></div>
          <div class="songTitle">${s.title}</div>
          <div style="color:#885">${s.artist}</div>
          <button class="playBtn">Play</button>`;
        card.querySelector('.playBtn').addEventListener('click',()=>{ loadSong(idx, true); });
        songsGrid.appendChild(card);
      });

      const ap = {
        audio: player,
        title: document.getElementById('apTitle'),
        now:   document.getElementById('apNow'),
        dur:   document.getElementById('apDur'),
        bar:   document.getElementById('apBar'),
        fill:  document.getElementById('apFill'),
        play:  document.getElementById('apPlay'),
        prev:  document.getElementById('apPrev'),
        next:  document.getElementById('apNext'),
        cover: document.getElementById('apCover'),
        i: -1
      };
      function fmt(t){ if(!isFinite(t)) return '0:00'; const m=Math.floor(t/60); const s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,'0')}`; }
      function loadSong(i, autoplay=false){
        ap.i = i;
        const s = songs[i];
        ap.audio.src = s.file;
        ap.title.textContent = `${s.title} ‚Äî ${s.artist}`;
        ap.cover.src = s.cover;
        if(autoplay){ ap.audio.play().then(()=>ap.play.textContent='‚ùö‚ùö').catch(()=>{}); }
      }
      function playPause(){ if(ap.audio.paused){ ap.audio.play().then(()=>ap.play.textContent='‚ùö‚ùö'); } else { ap.audio.pause(); ap.play.textContent='‚ñ∫'; } }
      ap.play.addEventListener('click', playPause);
      ap.prev.addEventListener('click', ()=>{ const ni = (ap.i<=0? songs.length-1 : ap.i-1); loadSong(ni, true); });
      ap.next.addEventListener('click', ()=>{ const ni = (ap.i>=songs.length-1? 0 : ap.i+1); loadSong(ni, true); });
      ap.audio.addEventListener('timeupdate', ()=>{ ap.fill.style.width = ((ap.audio.currentTime/(ap.audio.duration||1))*100)+'%'; ap.now.textContent = fmt(ap.audio.currentTime); ap.dur.textContent = fmt(ap.audio.duration); });
      ap.bar.addEventListener('click', (e)=>{ const r = ap.bar.getBoundingClientRect(); const ratio = (e.clientX - r.left) / r.width; ap.audio.currentTime = ratio * (ap.audio.duration||0); });
      ap.audio.addEventListener('ended', ()=> ap.next.click());

      // ===== PHOTOS behavior =====
      const photoSets = {
      calls: ['photos/calls/IMG1.jpg','photos/calls/IMG2.jpg','photos/calls/IMG3.jpg','photos/calls/IMG4.jpg','photos/calls/IMG5.jpg','photos/calls/IMG6.jpg','photos/calls/IMG7.jpg','photos/calls/IMG8.jpg','photos/calls/IMG9.JPG','photos/calls/IMG10.JPG','photos/calls/IMG11.JPG','photos/calls/IMG12.JPG','photos/calls/IMG13.JPG','photos/calls/IMG14.JPG','photos/calls/IMG15.JPG','photos/calls/IMG16.JPG','photos/calls/IMG17.JPG','photos/calls/IMG18.jpeg','photos/calls/IMG19.jpeg','photos/calls/IMG20.jpeg','photos/calls/IMG21.jpeg','photos/calls/IMG22.jpeg','photos/calls/IMG23.jpeg','photos/calls/IMG24.jpeg','photos/calls/IMG25.jpeg','photos/calls/IMG26.jpeg','photos/calls/VID1.mp4'],



      irl:   ['photos/realLife/IMG1.jpg','photos/realLife/IMG2.jpg','photos/realLife/IMG3.jpg','photos/realLife/IMG4.jpg','photos/realLife/IMG5.jpg','photos/realLife/IMG6.jpg','photos/realLife/VID1.mp4']
      };
      window.openPhotoCat = function(cat){
        document.getElementById('photoCats').style.display='none';
        const wall = document.getElementById('photosWall'); wall.style.display='block';
        const grid = document.getElementById('polaroidGrid'); grid.innerHTML = '';
        (photoSets[cat]||[]).forEach((src,idx)=>{
          const p = document.createElement('div');
          p.className = 'polaroid';
          p.style.setProperty('--rot', (Math.random()*2-1).toFixed(2));
          const isVideo = /\.(mp4|webm|ogg)$/i.test(src);
          p.innerHTML = isVideo
            ? `<span class="pin" aria-hidden="true"></span><video src="${src}" playsinline muted></video>`
            : `<span class="pin" aria-hidden="true"></span><img src="${src}" alt="memory ${idx+1}">`;
          // Click the whole card
          p.addEventListener('click', ()=> openLightbox(src, isVideo));
          grid.appendChild(p);
        });
      }
      window.closePhotoCat = function(){
        document.getElementById('photosWall').style.display='none';
        document.getElementById('photoCats').style.display='flex';
        document.getElementById('polaroidGrid').innerHTML='';
      }
    }

    function openPage(p){
      document.querySelectorAll('.hub, .page').forEach(el=>el.style.display='none');
      if(p==='hub'){ document.querySelector('.hub').style.display='flex'; cuteFooter.style.display='flex'; }
      else { document.getElementById(p).style.display='block'; cuteFooter.style.display='none'; }
    }

    // Lightbox
    function openLightbox(src, isVideo){
      const lb = document.getElementById('lightbox');
      const box = document.getElementById('lbContent');
      box.innerHTML = '';
      if(isVideo){ const v = document.createElement('video'); v.src = src; v.controls = true; v.playsInline = true; v.style.maxWidth = '100%'; v.style.maxHeight = '70vh'; box.appendChild(v); }
      else{ const img = new Image(); img.src = src; img.alt = 'memory'; img.style.maxWidth = '100%'; img.style.maxHeight = '70vh'; box.appendChild(img); }
      lb.style.display = 'flex';
    }
    (function(){
      const lb = document.getElementById('lightbox');
      const close = document.getElementById('lbClose');
      close.addEventListener('click', ()=> lb.style.display='none');
      lb.addEventListener('click', (e)=>{ if(e.target === lb) lb.style.display='none'; });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lb.style.display='none'; });
    })();

    // ===== Calendar (only built after unlock) =====
    function initLoveCalendar(){
      const btn = document.getElementById('calendarBtn');
      const cal = document.getElementById('calShell');
      const titleEl = document.getElementById('calTitle');

      // toggle open/close (never blocks when closed)
      btn.onclick = (e) => {
        e.stopPropagation();
        cal.classList.toggle('show');
        cal.setAttribute('aria-hidden', String(!cal.classList.contains('show')));
      };
      cal.addEventListener('click', (e)=> e.stopPropagation());
      document.addEventListener('click', ()=> {
        if (cal.classList.contains('show')) {
          cal.classList.remove('show');
          cal.setAttribute('aria-hidden','true');
        }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { cal.classList.remove('show'); cal.setAttribute('aria-hidden','true'); } });

      // builders
      function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}
      function buildMonth(y,m){
        const wrap=document.createElement('div');wrap.className='month';
        const title=document.createElement('div');title.className='m-title';
        title.textContent=new Date(y,m,1).toLocaleString('en-US',{month:'long'});wrap.appendChild(title);
        const grid=document.createElement('div');grid.className='grid';
        const DOW=["S","M","T","W","T","F","S"];
        DOW.forEach(d=>{const e=document.createElement('div');e.className='dow';e.textContent=d;grid.appendChild(e);});
        const first=new Date(y,m,1).getDay(), dim=daysInMonth(y,m), prevDim=daysInMonth(y,(m-1+12)%12);
        for(let i=0;i<first;i++){const d=document.createElement('div');d.className='day other';d.textContent=prevDim-first+1+i;grid.appendChild(d);}
        for(let d=1; d<=dim; d++){
          const cell = document.createElement('div');
          cell.className = 'day';
          cell.dataset.y = y;
          cell.dataset.m = m + 1;
          cell.dataset.d = d;
          cell.textContent = d;
          cell.addEventListener('click', () => onDayClick(y, m + 1, d));
          grid.appendChild(cell);
        }
        const cellsNeeded=7+first+dim, remainder=(Math.ceil(cellsNeeded/7)*7)-cellsNeeded;
        for(let i=1;i<=remainder;i++){const d=document.createElement('div');d.className='day other';d.textContent=i;grid.appendChild(d);}
        wrap.appendChild(grid);return wrap;
      }
      function buildYear(y){const grid=document.createElement('div');grid.className='month-wrap';for(let m=0;m<12;m++)grid.appendChild(buildMonth(y,m));return grid;}

      // render pages
      const y2025 = document.getElementById('year2025');
      const y2026 = document.getElementById('year2026');
      y2025.innerHTML=''; y2026.innerHTML='';
      y2025.appendChild(buildYear(2025));
      y2026.appendChild(buildYear(2026));

      // nav
      let currentYear = 2025;
      function switchYear(delta){
        const next = currentYear + delta;
        if (next < 2025 || next > 2026) return;
        document.querySelectorAll('.year-page').forEach(el => {
          el.classList.remove('visible');
          el.classList.add('hidden');
        });
        const show = document.getElementById('year' + next);
        show.classList.remove('hidden');
        show.classList.add('visible');
        currentYear = next;
        titleEl.textContent = `Our Little Calendar ‚Äî ${currentYear}`;
        renderMarks(); // refresh tags when changing year
      }

      document.getElementById('prevBtn').addEventListener('click', ()=>switchYear(-1));
      document.getElementById('nextBtn').addEventListener('click', ()=>switchYear(1));

      // helpers
      function qDay(y,m1,d){
        const page=document.getElementById('year'+y);
        return [...page.querySelectorAll('.day')].find(el=>+el.dataset.y===y && +el.dataset.m===m1 && +el.dataset.d===d);
      }

      // marks 2025 (static decorations)
      (function mark2025(){
        const c1=qDay(2025,7,15); if(c1) c1.classList.add('pen-circle');
        const c2=qDay(2025,7,20); if(c2) c2.classList.add('pen-circle');
        for(let d=19; d<=22; d++){ const el=qDay(2025,8,d); if(el) el.classList.add('pen-underline'); }
        const today=new Date();
        let y=2025,m=8,d=23;
        while(true){
          const endY=today.getFullYear(), endM=today.getMonth()+1, endD=today.getDate();
          if(y>endY || (y===endY && (m>endM || (m===endM && d>endD)))) break;
          const el=qDay(y,m,d); if(el) el.classList.add('pen-x');
          const dim=daysInMonth(y,m-1); d++; if(d>dim){ d=1; m++; if(m>12){m=1;y++;} }
        }
      })();

      // birthday 12/12 for 2025 & 2026
      function markBirthday(y){
        const b = qDay(y,12,12);
        if (b) { b.classList.add('pen-circle'); b.title = "My Wife‚Äôs birthdayyyy üéÇ"; }
      }
      markBirthday(2025);
      markBirthday(2026);

      // counters
      function inclusiveDaysFrom(startY,startM1,startD){
        const today=new Date();
        const A=Date.UTC(startY,startM1-1,startD);
        const B=Date.UTC(today.getFullYear(),today.getMonth(),today.getDate());
        return Math.round((B-A)/86400000)+1;
      }
      function updateSince(){
        const days=inclusiveDaysFrom(2025,8,22);
        document.getElementById('sinceText').textContent=`Day ${days} since the last hangout`;
      }
      function updateCountdown(){
        const now=new Date(); const pad=n=>String(n).padStart(2,'0');
        document.getElementById('countdown').textContent=
          `Next day in ${pad(23-now.getHours())}h:${pad(59-now.getMinutes())}m:${pad(59-now.getSeconds())}s`;
      }
      updateSince(); updateCountdown();
      setInterval(()=>{updateSince();updateCountdown();},1000);

      // ==== Shared calendar tags (no author field) ====
      let latestTags = {};

      function renderMarks() {
        // clear old marks
        document.querySelectorAll('.day.tagged').forEach(el => {
          el.classList.remove('tagged');
          el.removeAttribute('data-label');
        });

        const yearShown = (document.getElementById('calTitle').textContent.match(/(\d{4})$/)||[])[1] || '2025';
        const chips = document.getElementById('calChips');
        chips.innerHTML = '';

        // draw marks + tooltip
        Object.entries(latestTags).forEach(([k,obj])=>{
          if(!obj || !k.startsWith(yearShown)) return;
          const [yy,mm,dd] = k.split('-').map(Number);
          const el = [...document.querySelectorAll('.day')].find(e =>
            +e.dataset.y===yy && +e.dataset.m===mm && +e.dataset.d===dd
          );
          if(el){
            el.classList.add('tagged');
            el.dataset.label = obj.label;
          }
        });

        // chips list
        const entries = Object.entries(latestTags)
          .filter(([k])=>k.startsWith(yearShown))
          .sort((a,b)=>a[0].localeCompare(b[0]));

        for(const [k,obj] of entries){
          const dt = new Date(k);
          const pretty = dt.toLocaleString('en-US',{month:'short', day:'2-digit'});
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.innerHTML = `
            <span><b>${pretty}</b> ‚Äî ${escapeHtml(obj.label)}</span>
            <button class="x" title="Remove">‚úï</button>
          `;
          chip.querySelector('.x').onclick = () => TAGS_REF.child(k).remove();
          chips.appendChild(chip);
        }
      }

      // Add via inputs
      const tagDate = document.getElementById('tagDate');
      const tagLabel = document.getElementById('tagLabel');
      const addTagBtn = document.getElementById('addTagBtn');
      tagDate.value = todayISO();
      addTagBtn.addEventListener('click', ()=>{
        const dateVal = tagDate.value.trim();
        const labelVal = tagLabel.value.trim();
        if(!dateVal || !labelVal) return;
        TAGS_REF.child(dateVal).set({ label: labelVal, ts: Date.now() });
        tagLabel.value = '';
      });

      // clicking a day (guarded when hidden)
      function onDayClick(y, m1, d) {
        if (!cal.classList.contains('show')) return; // ignore if calendar is closed
        const k = `${y}-${String(m1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const current = latestTags[k]?.label || '';
        const txt = prompt(current ? 'Edit tag for this day:' : 'Add a tag for this day:', current);
        if (txt === null) return;
        const label = txt.trim();
        if (!label) return TAGS_REF.child(k).remove();
        TAGS_REF.child(k).set({ label, ts: Date.now() });
      }
      // expose to the buildMonth closure
      window.onDayClick = onDayClick;

      // live updates
      TAGS_REF.on('value', snap => {
        latestTags = snap.val() || {};
        renderMarks();
      });
    }

    // ===== Unlock =====
    function unlock(){
      const val = document.getElementById('codeField').value.trim();
      if(val === SECRET){
        showApp();
        initHub();
        // reveal + build calendar AFTER unlocking
        document.getElementById('calendarBtn').classList.remove('hiddenBeforeUnlock');
        document.getElementById('calShell').classList.remove('hiddenBeforeUnlock');
        initLoveCalendar();
      } else {
        document.getElementById('gateMsg').textContent = 'Wrong code ‚Äî try again.';
      }
    }

    showGate();
    document.getElementById('submitCode').addEventListener('click', unlock);
    document.getElementById('codeField').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); unlock(); } });

    // ===== Minimal self-tests =====
    (function(){
      try{
        console.assert(escapeHtml('a&b')==='a&amp;b','& escaping failed');
        console.assert(escapeHtml('<>')==='&lt;&gt;','angle escaping failed');
        console.assert(escapeHtml('x\ny').includes('<br>'),'newline to <br> failed');
        console.assert(typeof unlock==='function','unlock not defined');
        console.log('[Self-tests] OK');
      }catch(e){ console.error('[Self-tests] FAIL', e); }
    })();
  </script>
</body>
</html>
